<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NFC Sayfa</title>
  <style>
    :root{
      --bg1:#f6f8ff;
      --bg2:#eef2ff;
      --card:rgba(255,255,255,0.86);
      --text:#0f172a;
      --muted:#475569;
      --border:rgba(15,23,42,0.10);
      --shadow:rgba(2,6,23,0.12);
      --accent: 99,102,241;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0; min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      padding:18px;
      background:
        radial-gradient(900px 420px at 20% 15%, rgba(var(--accent),0.22), transparent 60%),
        radial-gradient(700px 340px at 80% 20%, rgba(var(--accent),0.14), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      transition: background 450ms ease;
    }
    .card{
      width:min(560px, 100%);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow:0 18px 55px var(--shadow);
      padding:16px;
      backdrop-filter: blur(12px);
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px; flex-wrap:wrap;
    }
    .pill{
      font-size:12px; color: var(--muted);
      background: rgba(255,255,255,0.78);
      border:1px solid rgba(15,23,42,0.08);
      padding:6px 10px;
      border-radius:999px;
      box-shadow: 0 8px 22px rgba(2,6,23,0.06);
      user-select:none;
      display:flex; align-items:center; gap:8px; white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgb(var(--accent));
      box-shadow: 0 0 0 3px rgba(var(--accent),0.18);
      flex:0 0 auto;
    }

    .photo-frame{
      width:100%;
      height: clamp(360px, 60vh, 600px);
      border-radius:20px;
      border:1px solid rgba(15,23,42,0.10);
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.68));
      box-shadow: 0 14px 34px rgba(2,6,23,0.14);
      padding:10px;
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .photo-frame::before{
      content:"";
      position:absolute; inset:-40px;
      background: radial-gradient(420px 280px at 50% 30%, rgba(var(--accent),0.24), transparent 72%);
      filter: blur(18px);
      opacity:0.95;
      pointer-events:none;
      transition: opacity 350ms ease;
    }
    .photo{
      width:100%; height:100%;
      object-fit: contain; object-position:center;
      border-radius:14px;
      display:block;
      user-select:none; -webkit-user-drag:none;
      opacity:0; transform: scale(0.995);
      transition: opacity 420ms ease, transform 420ms ease;
      position:relative; z-index:1;
      filter: saturate(1.06) contrast(1.02);
    }
    .photo.is-visible{ opacity:1; transform:scale(1); }

    .msg{ margin:14px 6px 0; font-size:1.10rem; line-height:1.45; min-height:3.2em; }
    .cursor{
      display:inline-block; width:0.55ch;
      background: rgba(var(--accent),0.30);
      margin-left:2px; border-radius:6px;
      transform: translateY(2px);
      animation: blink 1s infinite;
    }
    @keyframes blink{ 0%,49%{opacity:1} 50%,100%{opacity:0.15} }

    .sub{ margin:8px 6px 0; font-size:0.9rem; color:var(--muted); }

    .row{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    button{
      flex:1;
      border:1px solid rgba(15,23,42,0.12);
      background: rgba(var(--accent),0.10);
      color: var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:650;
      transition: background 160ms ease, transform 120ms ease;
      min-width: 150px;
    }
    button:hover{ background: rgba(var(--accent),0.16); }
    button:active{ transform: scale(0.99); }
    .ghost{ background: rgba(255,255,255,0.74); }

    .pop{ animation: pop 240ms ease; }
    @keyframes pop{ 0%{transform: translateY(2px); opacity:0.7} 100%{transform: translateY(0); opacity:1} }
  </style>
</head>
<body>
  <div class="card" id="card">
    <div class="topbar">
      <div class="pill" id="pillLeft"><span class="dot" aria-hidden="true"></span><span>Mesaj: â€”</span></div>
      <div class="pill" id="pillRight"><span>Foto: â€”</span></div>
      <div class="pill" id="pillMusic"><span>ðŸŽµ</span><span>MÃ¼zik: KapalÄ±</span></div>
    </div>

    <div class="photo-frame">
      <img id="photo" class="photo" alt="fotoÄŸraf" />
    </div>

    <div class="msg" id="message"></div>
    <div class="sub">Yenileyince yeni mesaj + foto gelir.</div>

    <div class="row">
      <button id="btnNew">Yeni getir</button>
      <button id="btnMusic" class="ghost">ðŸŽµ MÃ¼zik aÃ§</button>
      <button id="btnReset" class="ghost">Listeyi sÄ±fÄ±rla</button>
      <button id="btnShare" class="ghost">PaylaÅŸ</button>
    </div>
  </div>

  <script>
    // ====== AYARLAR ======
    const MESSAGES = [
      "BugÃ¼n de seni seviyorum.",
      "Kalbimden geÃ§enler: iyi ki varsÄ±n.",
      "Biraz susup sarÄ±lasÄ±m var.",
      "GÃ¼lÃ¼ÅŸÃ¼n dÃ¼nyayÄ± dÃ¼zeltemiyor ama beni dÃ¼zeltiyor.",
      "YanÄ±ndayÄ±m. Nokta.",
      "Ä°Ã§imden sana bir cÃ¼mle dÃ¼ÅŸÃ¼yor: Ã¶zledim."
    ];

    const PHOTO_DIR   = "assets/yunis/";
    const PHOTO_START = 1;
    const PHOTO_END   = 119; // âœ… 119 foto

    const MUSIC_SRC = "assets/music.mp3"; // âœ… bunu koy

    // ====== STORAGE ======
    function storageOK(){
      try{ const k="__t"; localStorage.setItem(k,"1"); localStorage.removeItem(k); return true; }
      catch(e){ return false; }
    }
    const HAS_LS = storageOK();
    const memStore = new Map();

    function lsGet(key, fallback){
      try{
        const raw = HAS_LS ? localStorage.getItem(key) : memStore.get(key);
        return raw ? JSON.parse(raw) : fallback;
      }catch(e){ return fallback; }
    }
    function lsSet(key, value){
      const raw = JSON.stringify(value);
      if(HAS_LS) localStorage.setItem(key, raw);
      else memStore.set(key, raw);
    }
    function lsDel(key){
      if(HAS_LS) localStorage.removeItem(key);
      else memStore.delete(key);
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    function getNextFromPool(poolKey, sourceArray){
      let pool = lsGet(poolKey, null);
      if(!Array.isArray(pool) || pool.length === 0){
        pool = shuffle([...sourceArray]);
      }
      const next = pool.pop();
      lsSet(poolKey, pool);
      return next;
    }

    function resetPool(poolKey){ lsDel(poolKey); }

    // ====== FOTO LÄ°STESÄ° (119) ======
    function pad4(n){ return String(n).padStart(4,"0"); }
    const PHOTO_LIST = (() => {
      const arr = [];
      for(let i=PHOTO_START;i<=PHOTO_END;i++){
        arr.push(PHOTO_DIR + pad4(i) + ".jpg");
      }
      return arr;
    })();

    // ====== TYPEWRITER ======
    let twTimer = null;
    function typewriter(el, text, speed=16){
      if(twTimer) clearInterval(twTimer);
      el.innerHTML = "";
      const span = document.createElement("span");
      const cur = document.createElement("span");
      cur.className = "cursor";
      el.appendChild(span);
      el.appendChild(cur);

      let i = 0;
      twTimer = setInterval(() => {
        i++;
        span.textContent = text.slice(0, i);
        if(i >= text.length){
          clearInterval(twTimer);
          twTimer = null;
        }
      }, speed);
    }

    // ====== TEMA RENGÄ° (HER FOTO) ======
    function setAccent(rgb){
      document.documentElement.style.setProperty("--accent", rgb);
    }

    function accentFromString(str){
      let h = 2166136261; // FNV-1a
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      const r = 70 + (h & 0x7F);
      const g = 70 + ((h>>8) & 0x7F);
      const b = 70 + ((h>>16) & 0x7F);
      return `${r},${g},${b}`;
    }

    function tryAccentFromImage(img){
      try{
        const c = document.createElement("canvas");
        const ctx = c.getContext("2d", { willReadFrequently:true });
        const w = 28, h = 28;
        c.width = w; c.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        const data = ctx.getImageData(0,0,w,h).data;

        let r=0,g=0,b=0,count=0;
        for(let i=0;i<data.length;i+=4){
          const a = data[i+3];
          if(a < 120) continue;
          r += data[i]; g += data[i+1]; b += data[i+2];
          count++;
        }
        if(count < 10) return null;

        r = Math.round(r/count);
        g = Math.round(g/count);
        b = Math.round(b/count);

        const max = Math.max(r,g,b), min = Math.min(r,g,b);
        if((max-min) < 10) return null;

        return `${r},${g},${b}`;
      }catch(e){
        return null;
      }
    }

    // ====== GARANTÄ° FARKLI SEÃ‡Ä°M ======
    function nextMessageDifferent(){
      const last = lsGet("last_msg", null);
      let chosen = null;
      for(let t=0;t<8;t++){
        chosen = getNextFromPool("msg_pool", MESSAGES);
        if(chosen !== last) break;
      }
      lsSet("last_msg", chosen);
      return chosen;
    }

    function nextPhotoDifferent(){
      const last = lsGet("last_photo", null);
      let chosen = null;
      for(let t=0;t<12;t++){
        chosen = getNextFromPool("photo_pool", PHOTO_LIST);
        if(chosen !== last) break;
      }
      lsSet("last_photo", chosen);
      return chosen;
    }

    function updatePills(){
      const msgPool = lsGet("msg_pool", []);
      const photoPool = lsGet("photo_pool", []);
      const left = document.getElementById("pillLeft");
      const right = document.getElementById("pillRight");
      left.querySelector("span:last-child").textContent = `Mesaj kaldÄ±: ${msgPool.length || MESSAGES.length}`;
      right.textContent = `Foto kaldÄ±: ${photoPool.length || PHOTO_LIST.length}`;
    }

    // ====== MÃœZÄ°K ======
    const audio = new Audio(MUSIC_SRC);
    audio.loop = true;
    audio.preload = "auto";
    audio.volume = lsGet("music_vol", 0.35);

    function setMusicUI(isOn){
      document.getElementById("pillMusic").lastElementChild.textContent = `MÃ¼zik: ${isOn ? "AÃ§Ä±k" : "KapalÄ±"}`;
      document.getElementById("btnMusic").textContent = isOn ? "ðŸ”‡ MÃ¼zik kapat" : "ðŸŽµ MÃ¼zik aÃ§";
    }

    async function musicOn(){
      try{
        await audio.play();
        lsSet("music_on", true);
        setMusicUI(true);
      }catch(e){
        // autoplay bloklandÄ±ysa UI'yi yine doÄŸru gÃ¶sterme, gerÃ§ekten Ã§almadÄ±
        lsSet("music_on", false);
        setMusicUI(false);
      }
    }
    function musicOff(){
      audio.pause();
      audio.currentTime = 0;
      lsSet("music_on", false);
      setMusicUI(false);
    }
    async function toggleMusic(){
      if(!audio.paused) musicOff();
      else await musicOn();
    }

    // ====== RENDER ======
    function renderNew(){
      const card = document.getElementById("card");
      card.classList.remove("pop"); void card.offsetWidth; card.classList.add("pop");

      const msg = nextMessageDifferent();
      const photoPath = nextPhotoDifferent();

      typewriter(document.getElementById("message"), msg, 16);

      // âœ… tema: daha yÃ¼klenmeden bile deÄŸiÅŸsin
      setAccent(accentFromString(photoPath));

      const img = document.getElementById("photo");
      img.classList.remove("is-visible");
      img.crossOrigin = "anonymous";

      img.onload = () => {
        const fromCanvas = tryAccentFromImage(img);
        if(fromCanvas) setAccent(fromCanvas); // Ã§alÄ±ÅŸÄ±rsa daha â€œfoto uyumluâ€
        img.classList.add("is-visible");
        updatePills();
      };

      img.onerror = () => {
        img.onerror = null;
        img.src = PHOTO_DIR + "0001.jpg?v=" + Date.now();
      };

      img.src = photoPath + "?v=" + Date.now();
    }

    // init
    updatePills();
    setMusicUI(lsGet("music_on", false));

    renderNew();

    // Yenilemede de deÄŸiÅŸsin (bfcache)
    window.addEventListener("pageshow", (e) => { if(e.persisted) renderNew(); });

    document.getElementById("btnNew").addEventListener("click", () => {
      renderNew();
      // kullanÄ±cÄ± etkileÅŸimi yakalanmÄ±ÅŸken, mÃ¼zik aÃ§Ä±ksa Ã§almayÄ± dene
      if(lsGet("music_on", false) && audio.paused) musicOn();
    });

    document.getElementById("btnMusic").addEventListener("click", toggleMusic);

    document.getElementById("btnReset").addEventListener("click", () => {
      resetPool("msg_pool");
      resetPool("photo_pool");
      lsDel("last_photo");
      lsDel("last_msg");
      renderNew();
    });

    document.getElementById("btnShare").addEventListener("click", async () => {
      const msg = document.getElementById("message").innerText.trim();
      if(navigator.share){
        try{ await navigator.share({ title:"Bir mesaj", text:msg, url:location.href }); }catch(e){}
      }else{
        try{ await navigator.clipboard.writeText(msg + "\n" + location.href); alert("KopyalandÄ±."); }
        catch(e){ alert("Bu cihaz paylaÅŸÄ±m/kopyalama konusunda dramayÄ± seÃ§miÅŸ."); }
      }
    });

    // Sayfa ilk kez aÃ§Ä±ldÄ±ÄŸÄ±nda: kullanÄ±cÄ± daha dokunmamÄ±ÅŸsa mÃ¼zik zaten baÅŸlayamaz.
    // Ama kullanÄ±cÄ± dokunursa ve "music_on=true" ise yukarÄ±daki yerlerde play deniyoruz.
  </script>
</body>
</html>
