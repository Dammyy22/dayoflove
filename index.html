<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bir Hediye</title>
  <style>
    :root{
      --night1:#050b16;
      --night2:#0a1330;
      --night3:#101a3a;

      --text:#eef3fb;
      --muted:rgba(238,243,251,0.62);
      --border:rgba(255,255,255,0.10);
      --shadow:rgba(0,0,0,0.55);

      --accent: 150,190,255; /* foto bazlƒ± deƒüi≈üiyor */
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      padding:18px;
      overflow-x:hidden;
      background:
        radial-gradient(900px 520px at 18% 16%, rgba(255,210,140,0.12), transparent 60%),
        radial-gradient(700px 420px at 80% 18%, rgba(var(--accent),0.12), transparent 62%),
        radial-gradient(700px 420px at 50% 80%, rgba(255,160,210,0.08), transparent 60%),
        linear-gradient(180deg, var(--night1), var(--night2) 55%, var(--night3));
      position:relative;
    }

    /* ‚≠ê YILDIZLAR (3 katman) */
    .stars, .stars2, .stars3{
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background-repeat:repeat; opacity:0.95; mix-blend-mode: screen;
    }
    .stars{
      background-image:
        radial-gradient(1px 1px at 10px 20px, rgba(255,255,255,0.55), transparent 60%),
        radial-gradient(1px 1px at 40px 70px, rgba(255,255,255,0.40), transparent 60%),
        radial-gradient(1px 1px at 90px 130px, rgba(255,255,255,0.35), transparent 60%),
        radial-gradient(1px 1px at 150px 30px, rgba(255,255,255,0.42), transparent 60%),
        radial-gradient(1px 1px at 210px 110px, rgba(255,255,255,0.30), transparent 60%);
      background-size: 220px 180px;
      animation: drift1 38s linear infinite;
    }
    .stars2{
      opacity:0.75;
      background-image:
        radial-gradient(1.5px 1.5px at 30px 50px, rgba(255,255,255,0.55), transparent 60%),
        radial-gradient(1.5px 1.5px at 120px 90px, rgba(255,255,255,0.42), transparent 60%),
        radial-gradient(1.5px 1.5px at 180px 140px, rgba(255,255,255,0.35), transparent 60%),
        radial-gradient(1.5px 1.5px at 70px 140px, rgba(255,255,255,0.32), transparent 60%);
      background-size: 260px 220px;
      animation: drift2 55s linear infinite;
    }
    .stars3{
      opacity:0.55;
      background-image:
        radial-gradient(2.2px 2.2px at 60px 40px, rgba(255,255,255,0.65), transparent 62%),
        radial-gradient(2.2px 2.2px at 160px 120px, rgba(255,255,255,0.48), transparent 62%),
        radial-gradient(2.2px 2.2px at 220px 70px, rgba(255,255,255,0.40), transparent 62%);
      background-size: 320px 260px;
      animation: drift3 80s linear infinite;
      filter: blur(0.2px);
    }
    @keyframes drift1{ 0%{transform:translate3d(0,0,0)} 100%{transform:translate3d(-120px,80px,0)} }
    @keyframes drift2{ 0%{transform:translate3d(0,0,0)} 100%{transform:translate3d(-90px,60px,0)} }
    @keyframes drift3{ 0%{transform:translate3d(0,0,0)} 100%{transform:translate3d(-60px,40px,0)} }

    /* nebula */
    .nebula{
      position:fixed; inset:-160px; pointer-events:none; z-index:0;
      background:
        radial-gradient(280px 220px at 18% 28%, rgba(255,210,140,0.12), transparent 70%),
        radial-gradient(360px 280px at 78% 22%, rgba(var(--accent),0.14), transparent 72%),
        radial-gradient(300px 240px at 55% 78%, rgba(255,160,210,0.12), transparent 72%);
      filter: blur(18px);
      opacity:0.95;
      animation: floatNebula 10s ease-in-out infinite;
    }
    @keyframes floatNebula{
      0%{ transform: translate3d(0,0,0) scale(1); }
      50%{ transform: translate3d(-18px, 10px,0) scale(1.02); }
      100%{ transform: translate3d(0,0,0) scale(1); }
    }

    /* ===== KAPAK ===== */
    .cover{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      padding:22px;
      z-index:999;
      transition: opacity 380ms ease, transform 380ms ease;
      background:
        radial-gradient(900px 520px at 15% 20%, rgba(160,180,255,0.14), transparent 60%),
        radial-gradient(700px 420px at 80% 15%, rgba(255,210,120,0.10), transparent 62%),
        linear-gradient(180deg, rgba(5,11,22,0.94), rgba(10,19,48,0.94));
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .cover.hidden{ opacity:0; pointer-events:none; transform: translateY(-6px); }
    .cover-card{
      width:min(520px, 100%);
      border-radius:26px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(10, 20, 38, 0.62);
      box-shadow: 0 26px 90px rgba(0,0,0,0.45);
      padding:18px;
      text-align:center;
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(14px);
      color:#eef3fb;
      z-index:1;
    }
    .cover-card::before{
      content:"";
      position:absolute; inset:-80px;
      background: radial-gradient(520px 320px at 50% 30%, rgba(var(--accent),0.20), transparent 70%);
      filter: blur(20px);
      pointer-events:none;
      opacity:0.9;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(238,243,251,0.78);
      font-size:12px;
      position:relative; z-index:1;
    }
    .title{ margin:14px 0 6px; font-size:26px; letter-spacing:-0.02em; position:relative; z-index:1; }
    .subtitle{ margin:0 0 14px; color: rgba(238,243,251,0.62); font-size:14px; position:relative; z-index:1; }
    .open-btn{
      width:100%;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(var(--accent),0.18);
      color:#eef3fb;
      border-radius:16px;
      padding:12px 14px;
      cursor:pointer;
      font-weight:800;
      font-size:15px;
      transition: background 160ms ease, transform 120ms ease;
      position:relative; z-index:1;
    }
    .open-btn:hover{ background: rgba(var(--accent),0.26); }
    .open-btn:active{ transform: scale(0.99); }

    /* ===== KONFETƒ∞ ===== */
    .confetti{ position:fixed; inset:0; pointer-events:none; overflow:hidden; z-index: 998; display:none; }
    .confetti.show{ display:block; }
    .piece{
      position:absolute; width:10px; height:14px; border-radius:3px;
      background: rgb(var(--accent)); opacity:0.9;
      animation: fall 1400ms ease-in forwards;
    }
    @keyframes fall{
      0%{ transform: translateY(-20px) rotate(0deg); opacity:0; }
      10%{ opacity:1; }
      100%{ transform: translateY(110vh) rotate(420deg); opacity:0.0; }
    }

    /* ===== ASIL SAYFA ===== */
    .card{
      width:min(560px, 100%);
      border-radius:22px;
      padding:16px;
      background: rgba(10, 20, 38, 0.56);
      border:1px solid rgba(255,255,255,0.10);
      box-shadow:0 24px 85px rgba(0,0,0,0.45);
      backdrop-filter: blur(14px);
      opacity:0;
      transform: translateY(6px);
      transition: opacity 420ms ease, transform 420ms ease;
      position:relative;
      z-index:1;
    }
    .card.ready{ opacity:1; transform: translateY(0); }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px; flex-wrap:wrap;
    }
    .pill{
      font-size:12px;
      color: rgba(238,243,251,0.72);
      background: rgba(255,255,255,0.06);
      border:1px solid rgba(255,255,255,0.10);
      padding:6px 10px;
      border-radius:999px;
      box-shadow: 0 10px 28px rgba(0,0,0,0.25);
      user-select:none;
      display:flex; align-items:center; gap:8px; white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgb(255,255,255);
      box-shadow: 0 0 0 3px rgba(255,255,255,0.14);
      flex:0 0 auto;
    }

    /* ===== FOTO √áER√áEVE + PULSE + HUZME ===== */
    .photo-frame{
      width:100%;
      height: clamp(360px, 60vh, 600px);
      border-radius:22px;
      position:relative;
      padding:10px;
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid rgba(255,255,255,0.12);
      box-shadow:
        0 18px 60px rgba(0,0,0,0.45),
        0 0 0 1px rgba(255,255,255,0.06) inset;
    }

    /* dƒ±≈üarƒ± ta≈üan beyaz halo (pulse) */
    .photo-frame::before{
      content:"";
      position:absolute;
      inset:-54px;
      border-radius:32px;
      background:
        radial-gradient(520px 360px at 50% 30%, rgba(255,255,255,0.42), transparent 70%),
        radial-gradient(720px 520px at 50% 70%, rgba(255,255,255,0.22), transparent 72%);
      filter: blur(18px);
      opacity:0.95;
      pointer-events:none;
      animation: glowPulse 3.2s ease-in-out infinite;
    }

    /* ƒ±≈üƒ±k huzmesi (≈üelale) */
    .photo-frame::after{
      content:"";
      position:absolute;
      inset:-40px;
      border-radius:30px;
      background:
        repeating-linear-gradient(
          110deg,
          rgba(255,255,255,0.00) 0px,
          rgba(255,255,255,0.12) 18px,
          rgba(255,255,255,0.00) 36px
        ),
        linear-gradient(180deg,
          rgba(255,255,255,0.24) 0%,
          rgba(255,255,255,0.07) 35%,
          rgba(255,255,255,0.00) 70%
        ),
        radial-gradient(620px 380px at 50% 40%, rgba(var(--accent),0.16), transparent 70%);
      filter: blur(20px);
      opacity:0.85;
      pointer-events:none;
      transform: translateY(-10px);
      animation: beamFlow 2.8s ease-in-out infinite;
    }

    @keyframes glowPulse{
      0%,100%{ opacity:0.78; transform: scale(1.00); }
      50%{ opacity:1.00; transform: scale(1.03); }
    }
    @keyframes beamFlow{
      0%{ opacity:0.55; transform: translateY(-22px) scale(1.00); }
      50%{ opacity:0.95; transform: translateY(8px) scale(1.02); }
      100%{ opacity:0.55; transform: translateY(-22px) scale(1.00); }
    }

    .photo{
      width:100%; height:100%;
      object-fit: contain; object-position:center;
      border-radius:16px;
      display:block;
      user-select:none; -webkit-user-drag:none;
      opacity:0; transform: scale(0.995);
      transition: opacity 420ms ease, transform 420ms ease;
      position:relative; z-index:1;
      filter: saturate(1.05) contrast(1.06) brightness(1.03);
      background: rgba(0,0,0,0.18);
    }
    .photo.is-visible{ opacity:1; transform:scale(1); }

    /* ===== KAVANOZ BUTONU (foto ekranƒ± √ºst√ºnde) ===== */
    .jar-btn{
      position:absolute;
      right:14px;
      bottom:14px;
      z-index:3;
      width:54px;
      height:54px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(10,20,38,0.45);
      backdrop-filter: blur(10px);
      box-shadow:
        0 18px 55px rgba(0,0,0,0.45),
        0 0 0 1px rgba(255,255,255,0.06) inset;
      cursor:pointer;
      display:grid;
      place-items:center;
      transition: transform 140ms ease, background 180ms ease, box-shadow 180ms ease;
      overflow:hidden;
    }
    .jar-btn:hover{
      background: rgba(10,20,38,0.58);
      box-shadow:
        0 18px 55px rgba(0,0,0,0.52),
        0 0 22px rgba(255,255,255,0.18);
    }
    .jar-btn:active{ transform: scale(0.98); }
    .jar-emoji{
      font-size:26px;
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.22));
    }
    .jar-btn::before{
      content:"";
      position:absolute;
      inset:-30px;
      background: radial-gradient(220px 160px at 50% 35%, rgba(255,255,255,0.18), transparent 70%);
      filter: blur(16px);
      opacity:0.85;
      pointer-events:none;
      animation: jarPulse 3.4s ease-in-out infinite;
    }
    @keyframes jarPulse{
      0%,100%{ opacity:0.55; transform: scale(1); }
      50%{ opacity:0.95; transform: scale(1.05); }
    }

    /* ===== MEKTUP MODAL (kavanoz + kaƒüƒ±t a√ßƒ±lƒ±r) ===== */
    .letter-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:1001;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(8px);
    }
    .letter-modal.show{ display:flex; }

    .letter-stage{
      width:min(560px, 100%);
      position:relative;
      border-radius:26px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(8,14,28,0.72);
      box-shadow: 0 30px 120px rgba(0,0,0,0.65);
      padding:16px;
      overflow:hidden;
    }
    .letter-stage::before{
      content:"";
      position:absolute;
      inset:-80px;
      background:
        radial-gradient(520px 320px at 20% 20%, rgba(255,210,140,0.14), transparent 70%),
        radial-gradient(520px 320px at 80% 25%, rgba(var(--accent),0.16), transparent 72%),
        radial-gradient(520px 320px at 50% 85%, rgba(255,160,210,0.12), transparent 72%);
      filter: blur(18px);
      opacity:0.95;
      pointer-events:none;
    }

    .letter-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      position:relative;
      z-index:1;
      margin-bottom:10px;
    }
    .letter-title{
      font-weight:800;
      letter-spacing:-0.02em;
      font-size:14px;
      color: rgba(238,243,251,0.86);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .close-btn{
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: rgba(238,243,251,0.9);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:800;
      transition: background 160ms ease, transform 120ms ease;
    }
    .close-btn:hover{ background: rgba(255,255,255,0.10); }
    .close-btn:active{ transform: scale(0.99); }

    /* kavanoz √ßizimi (CSS) */
    .jar{
      width: 190px;
      height: 250px;
      margin: 6px auto 10px;
      position:relative;
      z-index:1;
      filter: drop-shadow(0 18px 30px rgba(0,0,0,0.55));
    }
    .jar .lid{
      position:absolute;
      top:12px; left:50%;
      transform: translateX(-50%);
      width: 150px;
      height: 34px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.20), rgba(255,255,255,0.08));
      border:1px solid rgba(255,255,255,0.16);
      box-shadow: 0 10px 18px rgba(0,0,0,0.35);
      transform-origin: 12px 18px;
    }
    .jar .glass{
      position:absolute;
      top:42px; left:50%;
      transform: translateX(-50%);
      width: 170px;
      height: 190px;
      border-radius: 28px;
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.04));
      border:1px solid rgba(255,255,255,0.14);
      overflow:hidden;
    }
    .jar .shine{
      position:absolute;
      inset:-30px;
      background: radial-gradient(260px 200px at 30% 25%, rgba(255,255,255,0.18), transparent 60%);
      filter: blur(10px);
      opacity:0.9;
      pointer-events:none;
    }
    .jar .fairy{
      position:absolute;
      inset:0;
      background:
        radial-gradient(10px 10px at 20% 40%, rgba(255,210,140,0.32), transparent 60%),
        radial-gradient(12px 12px at 70% 55%, rgba(var(--accent),0.28), transparent 62%),
        radial-gradient(10px 10px at 45% 68%, rgba(255,160,210,0.24), transparent 62%),
        radial-gradient(9px 9px at 55% 35%, rgba(255,255,255,0.22), transparent 62%);
      filter: blur(6px);
      opacity:0.9;
      animation: fairyDrift 3.6s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes fairyDrift{
      0%,100%{ transform: translateY(0); opacity:0.78; }
      50%{ transform: translateY(-6px); opacity:1; }
    }

    /* kaƒüƒ±t (katlƒ± -> a√ßƒ±lƒ±r) */
    .paper{
      position:absolute;
      left:50%;
      top:92px;
      transform: translateX(-50%) scaleY(0.06);
      transform-origin: 50% 0%;
      width: 150px;
      height: 160px;
      border-radius: 14px;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.90));
      border:1px solid rgba(15,23,42,0.10);
      box-shadow:
        0 14px 40px rgba(0,0,0,0.28),
        0 0 0 1px rgba(255,255,255,0.40) inset;
      opacity:0;
      filter: saturate(1.02);
    }
    .paper::before{
      content:"";
      position:absolute;
      inset:10px;
      border-radius:12px;
      background:
        repeating-linear-gradient(
          180deg,
          rgba(0,0,0,0.00) 0px,
          rgba(0,0,0,0.00) 12px,
          rgba(0,0,0,0.06) 13px
        );
      opacity:0.35;
      pointer-events:none;
    }

    /* a√ßƒ±lma animasyonu tetiklenince */
    .letter-modal.show .jar .lid{
      animation: lidOpen 520ms ease forwards;
    }
    .letter-modal.show .paper{
      animation: paperUnfold 720ms cubic-bezier(.2,.9,.1,1) 220ms forwards;
    }

    @keyframes lidOpen{
      0%{ transform: translateX(-50%) rotate(0deg); }
      100%{ transform: translateX(-50%) rotate(-22deg) translateY(-4px); }
    }
    @keyframes paperUnfold{
      0%{ opacity:0; transform: translateX(-50%) scaleY(0.06); }
      35%{ opacity:1; }
      100%{ opacity:1; transform: translateX(-50%) scaleY(1); }
    }

    /* mektup i√ßeriƒüi */
    .letter-paper{
      position:relative;
      z-index:1;
      margin: 10px auto 0;
      width: min(520px, 100%);
      border-radius:18px;
      background: rgba(255,255,255,0.92);
      color:#0f172a;
      border:1px solid rgba(15,23,42,0.10);
      box-shadow: 0 18px 70px rgba(0,0,0,0.35);
      padding:16px 16px 14px;
      display:none;
    }
    .letter-modal.show .letter-paper{ display:block; }

    .letter-paper .sig{
      margin-top:12px;
      color: rgba(15,23,42,0.62);
      font-weight:800;
      font-size:13px;
    }
    .letter-text{
      white-space:pre-wrap;
      line-height:1.5;
      font-size:15px;
    }

    .msg{ margin:14px 6px 0; font-size:1.10rem; line-height:1.45; min-height:3.2em; color: rgba(238,243,251,0.92); }
    .cursor{
      display:inline-block; width:0.55ch;
      background: rgba(255,255,255,0.35);
      margin-left:2px; border-radius:6px;
      transform: translateY(2px);
      animation: blink 1s infinite;
    }
    @keyframes blink{ 0%,49%{opacity:1} 50%,100%{opacity:0.15} }

    .sub{ margin:8px 6px 0; font-size:0.9rem; color: var(--muted); }

    .row{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    button{
      flex:1;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.08);
      color: rgba(238,243,251,0.92);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:650;
      transition: background 160ms ease, transform 120ms ease;
      min-width: 150px;
    }
    button:hover{ background: rgba(255,255,255,0.12); }
    button:active{ transform: scale(0.99); }
    .ghost{ background: rgba(255,255,255,0.06); }

    .pop{ animation: pop 240ms ease; }
    @keyframes pop{ 0%{transform: translateY(2px); opacity:0.7} 100%{transform: translateY(0); opacity:1} }
  </style>
</head>
<body>
  <div class="stars"></div>
  <div class="stars2"></div>
  <div class="stars3"></div>
  <div class="nebula"></div>

  <div class="confetti" id="confetti"></div>

  <!-- MEKTUP MODAL -->
  <div class="letter-modal" id="letterModal" aria-hidden="true">
    <div class="letter-stage" id="letterStage" role="dialog" aria-modal="true">
      <div class="letter-top">
        <div class="letter-title">ü´ô Kavanozdaki Mektup</div>
        <button class="close-btn" id="btnLetterClose">Kapat</button>
      </div>

      <div class="jar" aria-hidden="true">
        <div class="lid"></div>
        <div class="glass">
          <div class="shine"></div>
          <div class="fairy"></div>
        </div>
        <div class="paper"></div>
      </div>

      <div class="letter-paper" id="letterPaper">
        <div class="letter-text" id="letterText"></div>
        <div class="sig" id="letterSig"></div>
      </div>
    </div>
  </div>

  <!-- KAPAK -->
  <div class="cover" id="cover">
    <div class="cover-card">
      <div class="badge">üéÅ <span>Senin i√ßin k√º√ß√ºk bir ≈üey</span></div>
      <div class="title">Bir Hediyen Var</div>
      <div class="subtitle">A√ßƒ±nca fotoƒüraf + mesaj + m√ºzik ba≈ülar.</div>
      <button class="open-btn" id="btnOpen">Hediyeyi A√ß ‚ú®</button>
    </div>
  </div>

  <!-- ƒ∞√áERƒ∞K -->
  <div class="card" id="card">
    <div class="topbar">
      <div class="pill" id="pillLeft"><span class="dot" aria-hidden="true"></span><span>Mesaj: ‚Äî</span></div>
      <div class="pill" id="pillRight"><span>Foto: ‚Äî</span></div>
      <div class="pill" id="pillMusic"><span>üéµ</span><span>M√ºzik: Kapalƒ±</span></div>
    </div>

    <div class="photo-frame">
      <img id="photo" class="photo" alt="fotoƒüraf" />
      <button class="jar-btn" id="btnJar" title="Kavanozdaki mektubu a√ß">
        <span class="jar-emoji">ü´ô</span>
      </button>
    </div>

    <div class="msg" id="message"></div>
    <div class="sub">Yenileyince yeni mesaj + foto gelir.</div>

    <div class="row">
      <button id="btnNew">Yeni getir</button>
      <button id="btnMusic" class="ghost">üéµ M√ºzik a√ß</button>
      <button id="btnReset" class="ghost">Listeyi sƒ±fƒ±rla</button>
      <button id="btnShare" class="ghost">Payla≈ü</button>
    </div>
  </div>

  <script>
    // === SEN BURAYI D√úZENLE ===
    const LETTER_TEXT =
`Yunisim,

Bunu okurken nerede olursan ol, bil ki aklƒ±mƒ±n bir k√∂≈üesinde hep sen varsƒ±n.
Bazen g√ºnler karƒ±≈üƒ±yor, bazen ben daƒüƒ±lƒ±yorum ama‚Ä¶ seninle toparlanmayƒ± seviyorum.

Bu kavanozun i√ßinde sakladƒ±ƒüƒ±m ≈üey bir ‚Äúmektup‚Äù gibi dursa da aslƒ±nda:
Benim i√ßimde b√ºy√ºyen ‚Äúiyi ki‚Äùlerin toplamƒ±.

Seni seviyorum.`;

    const LETTER_SIGN = "‚Äî Dammy";

    // ====== AYARLAR ======
    const MESSAGES = [
      "Bug√ºn de seni seviyorum.",
      "Kalbimden ge√ßenler: iyi ki varsƒ±n.",
      "Biraz susup sarƒ±lasƒ±m var.",
      "G√ºl√º≈ü√ºn d√ºnyayƒ± d√ºzeltemiyor ama beni d√ºzeltiyor.",
      "Yanƒ±ndayƒ±m. Nokta.",
      "ƒ∞√ßimden sana bir c√ºmle d√º≈ü√ºyor: √∂zledim."
    ];

    const PHOTO_DIR   = "assets/yunis/";
    const PHOTO_START = 1;
    const PHOTO_END   = 119;

    const MUSIC_SRC = "assets/music.mp3";

    // ====== STORAGE ======
    function storageOK(){
      try{ const k="__t"; localStorage.setItem(k,"1"); localStorage.removeItem(k); return true; }
      catch(e){ return false; }
    }
    const HAS_LS = storageOK();
    const memStore = new Map();

    function lsGet(key, fallback){
      try{
        const raw = HAS_LS ? localStorage.getItem(key) : memStore.get(key);
        return raw ? JSON.parse(raw) : fallback;
      }catch(e){ return fallback; }
    }
    function lsSet(key, value){
      const raw = JSON.stringify(value);
      if(HAS_LS) localStorage.setItem(key, raw);
      else memStore.set(key, raw);
    }
    function lsDel(key){
      if(HAS_LS) localStorage.removeItem(key);
      else memStore.delete(key);
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }
    function getNextFromPool(poolKey, sourceArray){
      let pool = lsGet(poolKey, null);
      if(!Array.isArray(pool) || pool.length === 0){
        pool = shuffle([...sourceArray]);
      }
      const next = pool.pop();
      lsSet(poolKey, pool);
      return next;
    }
    function resetPool(poolKey){ lsDel(poolKey); }

    // ====== FOTO Lƒ∞STESƒ∞ ======
    function pad4(n){ return String(n).padStart(4,"0"); }
    const PHOTO_LIST = (() => {
      const arr = [];
      for(let i=PHOTO_START;i<=PHOTO_END;i++){
        arr.push(PHOTO_DIR + pad4(i) + ".jpg");
      }
      return arr;
    })();

    // ====== TYPEWRITER ======
    let twTimer = null;
    function typewriter(el, text, speed=16){
      if(twTimer) clearInterval(twTimer);
      el.innerHTML = "";
      const span = document.createElement("span");
      const cur = document.createElement("span");
      cur.className = "cursor";
      el.appendChild(span);
      el.appendChild(cur);

      let i = 0;
      twTimer = setInterval(() => {
        i++;
        span.textContent = text.slice(0, i);
        if(i >= text.length){
          clearInterval(twTimer);
          twTimer = null;
        }
      }, speed);
    }

    // ====== TEMA (HER FOTO) ======
    function setAccent(rgb){ document.documentElement.style.setProperty("--accent", rgb); }
    function accentFromString(str){
      let h = 2166136261;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      const r = 70 + (h & 0x7F);
      const g = 70 + ((h>>8) & 0x7F);
      const b = 70 + ((h>>16) & 0x7F);
      return `${r},${g},${b}`;
    }
    function tryAccentFromImage(img){
      try{
        const c = document.createElement("canvas");
        const ctx = c.getContext("2d", { willReadFrequently:true });
        const w = 28, h = 28;
        c.width = w; c.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        const data = ctx.getImageData(0,0,w,h).data;

        let r=0,g=0,b=0,count=0;
        for(let i=0;i<data.length;i+=4){
          const a = data[i+3];
          if(a < 120) continue;
          r += data[i]; g += data[i+1]; b += data[i+2];
          count++;
        }
        if(count < 10) return null;

        r = Math.round(r/count);
        g = Math.round(g/count);
        b = Math.round(b/count);

        const max = Math.max(r,g,b), min = Math.min(r,g,b);
        if((max-min) < 10) return null;

        return `${r},${g},${b}`;
      }catch(e){ return null; }
    }

    // ====== GARANTƒ∞ FARKLI SE√áƒ∞M ======
    function nextMessageDifferent(){
      const last = lsGet("last_msg", null);
      let chosen = null;
      for(let t=0;t<8;t++){
        chosen = getNextFromPool("msg_pool", MESSAGES);
        if(chosen !== last) break;
      }
      lsSet("last_msg", chosen);
      return chosen;
    }
    function nextPhotoDifferent(){
      const last = lsGet("last_photo", null);
      let chosen = null;
      for(let t=0;t<12;t++){
        chosen = getNextFromPool("photo_pool", PHOTO_LIST);
        if(chosen !== last) break;
      }
      lsSet("last_photo", chosen);
      return chosen;
    }

    function updatePills(){
      const msgPool = lsGet("msg_pool", []);
      const photoPool = lsGet("photo_pool", []);
      const left = document.getElementById("pillLeft");
      const right = document.getElementById("pillRight");
      left.querySelector("span:last-child").textContent = `Mesaj kaldƒ±: ${msgPool.length || MESSAGES.length}`;
      right.textContent = `Foto kaldƒ±: ${photoPool.length || PHOTO_LIST.length}`;
    }

    // ====== M√úZƒ∞K ======
    const audio = new Audio(MUSIC_SRC);
    audio.loop = true;
    audio.preload = "auto";
    audio.volume = lsGet("music_vol", 0.35);

    function setMusicUI(isOn){
      document.getElementById("pillMusic").lastElementChild.textContent = `M√ºzik: ${isOn ? "A√ßƒ±k" : "Kapalƒ±"}`;
      document.getElementById("btnMusic").textContent = isOn ? "üîá M√ºzik kapat" : "üéµ M√ºzik a√ß";
    }
    async function musicOn(){
      try{
        await audio.play();
        lsSet("music_on", true);
        setMusicUI(true);
      }catch(e){
        lsSet("music_on", false);
        setMusicUI(false);
      }
    }
    function musicOff(){
      audio.pause();
      audio.currentTime = 0;
      lsSet("music_on", false);
      setMusicUI(false);
    }
    async function toggleMusic(){
      if(!audio.paused) musicOff();
      else await musicOn();
    }

    // ====== KONFETƒ∞ ======
    function popConfetti(){
      const layer = document.getElementById("confetti");
      layer.innerHTML = "";
      layer.classList.add("show");
      const n = 22;
      for(let i=0;i<n;i++){
        const p = document.createElement("div");
        p.className = "piece";
        p.style.left = (Math.random()*100) + "vw";
        p.style.animationDelay = (Math.random()*120) + "ms";
        p.style.opacity = (0.6 + Math.random()*0.4).toFixed(2);
        p.style.background = `rgba(var(--accent),${(0.75+Math.random()*0.25).toFixed(2)})`;
        layer.appendChild(p);
      }
      setTimeout(() => {
        layer.classList.remove("show");
        layer.innerHTML = "";
      }, 1600);
    }

    // ====== RENDER ======
    function renderNew(){
      const msg = nextMessageDifferent();
      const photoPath = nextPhotoDifferent();

      typewriter(document.getElementById("message"), msg, 16);

      setAccent(accentFromString(photoPath));

      const img = document.getElementById("photo");
      img.classList.remove("is-visible");
      img.crossOrigin = "anonymous";

      img.onload = () => {
        const fromCanvas = tryAccentFromImage(img);
        if(fromCanvas) setAccent(fromCanvas);
        img.classList.add("is-visible");
        updatePills();
      };

      img.onerror = () => {
        img.onerror = null;
        img.src = PHOTO_DIR + "0001.jpg?v=" + Date.now();
      };

      img.src = photoPath + "?v=" + Date.now();
    }

    // ====== KAPAK A√á ======
    const cover = document.getElementById("cover");
    const card = document.getElementById("card");
    document.getElementById("btnOpen").addEventListener("click", () => {
      cover.classList.add("hidden");
      card.classList.add("ready");
      popConfetti();
      renderNew();
      musicOn();
    });

    // ====== MEKTUP ======
    const letterModal = document.getElementById("letterModal");
    const letterStage = document.getElementById("letterStage");
    const btnJar = document.getElementById("btnJar");
    const btnLetterClose = document.getElementById("btnLetterClose");

    document.getElementById("letterText").textContent = LETTER_TEXT;
    document.getElementById("letterSig").textContent = LETTER_SIGN;

    function openLetter(){
      letterModal.classList.add("show");
      letterModal.setAttribute("aria-hidden", "false");
      // animasyon restart (css animation‚Äôƒ± tekrar tetiklemek i√ßin)
      letterStage.style.display = "none";
      void letterStage.offsetHeight;
      letterStage.style.display = "";
    }
    function closeLetter(){
      letterModal.classList.remove("show");
      letterModal.setAttribute("aria-hidden", "true");
    }

    btnJar.addEventListener("click", openLetter);
    btnLetterClose.addEventListener("click", closeLetter);

    // modal dƒ±≈üƒ±na tƒ±klayƒ±nca kapat
    letterModal.addEventListener("click", (e) => {
      if(e.target === letterModal) closeLetter();
    });
    // ESC ile kapat
    window.addEventListener("keydown", (e) => {
      if(e.key === "Escape" && letterModal.classList.contains("show")) closeLetter();
    });

    // ====== BUTONLAR ======
    updatePills();
    setMusicUI(lsGet("music_on", false));

    document.getElementById("btnNew").addEventListener("click", () => {
      renderNew();
      if(lsGet("music_on", false) && audio.paused) musicOn();
    });
    document.getElementById("btnMusic").addEventListener("click", toggleMusic);

    document.getElementById("btnReset").addEventListener("click", () => {
      resetPool("msg_pool");
      resetPool("photo_pool");
      lsDel("last_photo");
      lsDel("last_msg");
      renderNew();
    });

    document.getElementById("btnShare").addEventListener("click", async () => {
      const msg = document.getElementById("message").innerText.trim();
      if(navigator.share){
        try{ await navigator.share({ title:"Bir mesaj", text:msg, url:location.href }); }catch(e){}
      }else{
        try{ await navigator.clipboard.writeText(msg + "\n" + location.href); alert("Kopyalandƒ±."); }
        catch(e){ alert("Bu cihaz payla≈üƒ±m/kopyalama konusunda dramayƒ± se√ßmi≈ü."); }
      }
    });

    window.addEventListener("pageshow", (e) => {
      if(e.persisted){
        if(card.classList.contains("ready")) renderNew();
      }
    });
  </script>
</body>
</html>
