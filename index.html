<script>
function istanbulNow(){
  return new Date(new Date().toLocaleString("en-US",{timeZone:"Europe/Istanbul"}));
}
function istanbulKey(){
  const n = istanbulNow();
  return `${n.getFullYear()}-${String(n.getMonth()+1).padStart(2,'0')}-${String(n.getDate()).padStart(2,'0')}`;
}
function hashIndex(key, len){
  let h = 0;
  for(let i=0;i<key.length;i++) h = (h*31 + key.charCodeAt(i)) >>> 0;
  return h % len;
}

/* üì∑ FOTO Lƒ∞STESƒ∞ (assets/yunis/) */
const photos = [
  { src:"assets/yunis/01.jpg", caption:"Deneme 1" },
  { src:"assets/yunis/02.jpg", caption:"Deneme 2" },
  { src:"assets/yunis/03.jpg", caption:"Deneme 3" },
];

/* üíå G√úNL√úK YAZILAR */
const entries = [
  {
    id:"LOVE-001",
    mood:"yumu≈üak",
    text:`Bug√ºn seni sevdiƒüimi ispatlamak i√ßin bir ≈üey yapmam gerekmiyor.
Sevgi bazen sessizce yanƒ±nda durabilmek.`,
    source:"Dammy ‚Üí Yunis",
    remember:"Bug√ºn k√º√ß√ºk bir ≈üey yap: ‚Äòiyi ki varsƒ±n‚Äô de."
  },
  {
    id:"LOVE-002",
    mood:"g√ºl√ºmseten",
    text:`Seninle konu≈üurken c√ºmlelerim d√ºzg√ºn deƒüilse,
sebebi T√ºrk√ßem deƒüil.
Kafamƒ±n i√ßi ‚ÄòYunis‚Äô diye baƒüƒ±rƒ±yor.`,
    source:"Dammy ‚Üí Yunis"
  },
  {
    id:"LOVE-003",
    mood:"derin",
    text:`Birlikte b√ºy√ºmek bazen kolay deƒüil.
Ama ben ‚Äòkolay‚Äô diye deƒüil,
‚Äòsen‚Äô diye se√ßtim.`,
    source:"Dammy ‚Üí Yunis",
    remember:"Bug√ºn ≈üu soruyu sor: ‚ÄòBunu senin i√ßin daha iyi nasƒ±l yaparƒ±m?‚Äô"
  }
];

// Script patlarsa ekranda bir ≈üey yazsƒ±n
window.addEventListener("error", (e) => {
  const el = document.getElementById("msg");
  if(el) el.textContent = "Bir ≈üeyler bozuldu. Konsola bak (F12).";
  console.error(e);
});

document.addEventListener("DOMContentLoaded", () => {
  const now = istanbulNow();
  const hour = now.getHours();
  const isDay = (hour >= 6 && hour < 19);
  if(isDay) document.body.classList.add("day");

  const key = istanbulKey();

  // Chip'ler
  const chipDayNight = document.getElementById("chipDayNight");
  const chipKey = document.getElementById("chipKey");
  const chipMood = document.getElementById("chipMood");
  if(chipDayNight) chipDayNight.textContent = isDay ? "G√ºnd√ºz modu" : "Gece modu";
  if(chipKey) chipKey.textContent = `G√ºn: ${key}`;

  // DOM
  const msgEl = document.getElementById("msg");
  const sourceEl = document.getElementById("source");
  const dateEl = document.getElementById("date");
  const rememberEl = document.getElementById("remember");

  const photoCard = document.getElementById("photoCard");
  const photoEl = document.getElementById("photo");
  const captionEl = document.getElementById("caption");

  if(!msgEl || !dateEl){
    console.error("DOM eksik:", { msgEl, dateEl });
    return;
  }

  // G√ºnl√ºk sabit yazƒ±
  let current = hashIndex(key + "|entry", entries.length);

  function render(i){
    const item = entries[i];

    msgEl.textContent = item.text;
    if(sourceEl) sourceEl.textContent = item.source ? `Kaynak: ${item.source}` : "";
    dateEl.textContent = `‚Ä¢ ${key}`;
    if(chipMood) chipMood.textContent = item.mood ? `Mod: ${item.mood}` : "Mod: ‚Äî";

    if(rememberEl){
      if(item.remember){
        rememberEl.style.display = "block";
        rememberEl.textContent = `Bug√ºn ≈üunu hatƒ±rla: ${item.remember}`;
      } else {
        rememberEl.style.display = "none";
      }
    }

    // G√ºnl√ºk sabit foto (entry'den baƒüƒ±msƒ±z)
    if(photoCard && photoEl && captionEl){
      if(photos.length > 0){
        const pIdx = hashIndex(key + "|photo", photos.length);
        const p = photos[pIdx];
        photoEl.src = p.src;
        captionEl.textContent = p.caption || "Bug√ºn√ºn fotoƒürafƒ±";
        photoCard.style.display = "block";
      } else {
        photoCard.style.display = "none";
      }
    }

    // Uzun metin font ayarƒ±
    const L = item.text.length;
    msgEl.style.fontSize = (L > 700) ? "18px" : "20px";
    if(L > 1000) msgEl.style.fontSize = "17px";
  }

  render(current);

  // Butonlar
  const btnShuffle = document.getElementById("btnShuffle");
  const btnCopy = document.getElementById("btnCopy");

  if(btnShuffle){
    btnShuffle.addEventListener("click", () => {
      // aynƒ± g√ºn i√ßinde yazƒ±yƒ± deƒüi≈ütir: ‚Äúfarklƒ± bir tane‚Äù
      current = (current + 1) % entries.length;
      render(current);
    });
  }

  if(btnCopy){
    btnCopy.addEventListener("click", async () => {
      try{
        await navigator.clipboard.writeText(entries[current].text);
        const old = btnCopy.textContent;
        btnCopy.textContent = "Kopyalandƒ± ‚úì";
        setTimeout(()=>btnCopy.textContent = old, 900);
      }catch{
        alert("Kopyalama izni yok. Metni se√ßip kopyalayabilirsin.");
      }
    });
  }
});
</script>
