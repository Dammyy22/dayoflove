<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bir Hediye</title>
  <style>
    :root{
      --bg1:#f6f8ff;
      --bg2:#eef2ff;
      --card:rgba(255,255,255,0.86);
      --text:#0f172a;
      --muted:#475569;
      --border:rgba(15,23,42,0.10);
      --shadow:rgba(2,6,23,0.12);
      --accent: 99,102,241;

      /* kapak gece paleti */
      --night1:#06101f;
      --night2:#0a1730;
      --night3:#0c2144;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0; min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      padding:18px;
      background:
        radial-gradient(900px 420px at 20% 15%, rgba(var(--accent),0.22), transparent 60%),
        radial-gradient(700px 340px at 80% 20%, rgba(var(--accent),0.14), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      transition: background 450ms ease;
      overflow-x:hidden;
    }

    /* =======================
       üåô HEDƒ∞YE KAPAK (GECE + PERƒ∞ LED)
       ======================= */
    .cover{
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:22px;

      /* gece gradyan */
      background:
        radial-gradient(900px 520px at 15% 20%, rgba(160,180,255,0.14), transparent 60%),
        radial-gradient(700px 420px at 80% 15%, rgba(255,210,120,0.10), transparent 62%),
        linear-gradient(180deg, var(--night1), var(--night2) 55%, var(--night3));
      z-index:999;
      transition: opacity 380ms ease, transform 380ms ease;
      overflow:hidden;
    }
    .cover.hidden{
      opacity:0;
      pointer-events:none;
      transform: translateY(-6px);
    }

    /* peri led: bokeh katmanƒ± */
    .cover::before{
      content:"";
      position:absolute;
      inset:-120px;
      background:
        radial-gradient(16px 16px at 8% 18%, rgba(255,227,162,0.55), transparent 60%),
        radial-gradient(22px 22px at 18% 32%, rgba(160,210,255,0.45), transparent 62%),
        radial-gradient(18px 18px at 33% 24%, rgba(255,180,220,0.38), transparent 62%),
        radial-gradient(26px 26px at 44% 40%, rgba(255,236,170,0.40), transparent 64%),
        radial-gradient(18px 18px at 58% 22%, rgba(150,255,230,0.30), transparent 62%),
        radial-gradient(28px 28px at 70% 35%, rgba(170,190,255,0.40), transparent 65%),
        radial-gradient(16px 16px at 82% 20%, rgba(255,210,120,0.55), transparent 60%),
        radial-gradient(24px 24px at 90% 38%, rgba(255,170,210,0.30), transparent 66%),
        radial-gradient(14px 14px at 20% 70%, rgba(255,227,162,0.35), transparent 60%),
        radial-gradient(22px 22px at 46% 78%, rgba(160,210,255,0.28), transparent 66%),
        radial-gradient(18px 18px at 78% 72%, rgba(255,210,120,0.32), transparent 66%);
      filter: blur(10px);
      opacity:0.95;
      animation: floatBokeh 7s ease-in-out infinite;
      pointer-events:none;
    }

    /* yƒ±ldƒ±z tozu */
    .cover::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(1px 1px at 10% 15%, rgba(255,255,255,0.35), transparent 60%),
        radial-gradient(1px 1px at 22% 42%, rgba(255,255,255,0.25), transparent 60%),
        radial-gradient(1px 1px at 35% 28%, rgba(255,255,255,0.28), transparent 60%),
        radial-gradient(1px 1px at 48% 18%, rgba(255,255,255,0.22), transparent 60%),
        radial-gradient(1px 1px at 63% 34%, rgba(255,255,255,0.25), transparent 60%),
        radial-gradient(1px 1px at 74% 22%, rgba(255,255,255,0.24), transparent 60%),
        radial-gradient(1px 1px at 86% 44%, rgba(255,255,255,0.20), transparent 60%),
        radial-gradient(1px 1px at 18% 78%, rgba(255,255,255,0.18), transparent 60%),
        radial-gradient(1px 1px at 52% 82%, rgba(255,255,255,0.16), transparent 60%),
        radial-gradient(1px 1px at 88% 74%, rgba(255,255,255,0.14), transparent 60%);
      opacity:0.9;
      animation: twinkle 3.8s ease-in-out infinite;
      pointer-events:none;
    }

    @keyframes floatBokeh{
      0%   { transform: translate3d(0,0,0) scale(1); }
      50%  { transform: translate3d(-18px, 10px,0) scale(1.02); }
      100% { transform: translate3d(0,0,0) scale(1); }
    }
    @keyframes twinkle{
      0%,100%{ opacity:0.75; }
      50%{ opacity:1; }
    }

    .cover-card{
      width:min(520px, 100%);
      border-radius:26px;
      border:1px solid rgba(255,255,255,0.10);
      /* gece cam efekti */
      background: rgba(10, 20, 38, 0.62);
      box-shadow: 0 26px 90px rgba(0,0,0,0.45);
      padding:18px;
      text-align:center;
      position:relative;
      overflow:hidden;
      backdrop-filter: blur(14px);
      color: #eef3fb;
      z-index:1;
    }
    .cover-card::before{
      content:"";
      position:absolute;
      inset:-70px;
      background: radial-gradient(520px 320px at 50% 30%, rgba(var(--accent),0.22), transparent 70%);
      filter: blur(18px);
      pointer-events:none;
      opacity:0.9;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      color: rgba(238,243,251,0.78);
      font-size:12px;
      position:relative;
      z-index:1;
    }
    .title{
      margin:14px 0 6px;
      font-size:26px;
      letter-spacing:-0.02em;
      position:relative;
      z-index:1;
    }
    .subtitle{
      margin:0 0 14px;
      color: rgba(238,243,251,0.62);
      font-size:14px;
      position:relative;
      z-index:1;
    }
    .open-btn{
      width:100%;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(var(--accent),0.18);
      color: #eef3fb;
      border-radius:16px;
      padding:12px 14px;
      cursor:pointer;
      font-weight:800;
      font-size:15px;
      transition: background 160ms ease, transform 120ms ease;
      position:relative;
      z-index:1;
    }
    .open-btn:hover{ background: rgba(var(--accent),0.26); }
    .open-btn:active{ transform: scale(0.99); }

    /* ===== KONFETƒ∞ ===== */
    .confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index: 998;
      display:none;
    }
    .confetti.show{ display:block; }
    .piece{
      position:absolute;
      width:10px; height:14px;
      border-radius:3px;
      background: rgb(var(--accent));
      opacity:0.9;
      animation: fall 1400ms ease-in forwards;
    }
    @keyframes fall{
      0%{ transform: translateY(-20px) rotate(0deg); opacity:0; }
      10%{ opacity:1; }
      100%{ transform: translateY(110vh) rotate(420deg); opacity:0.0; }
    }

    /* ===== ASIL SAYFA ===== */
    .card{
      width:min(560px, 100%);
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow:0 18px 55px var(--shadow);
      padding:16px;
      backdrop-filter: blur(12px);
      opacity:0;
      transform: translateY(6px);
      transition: opacity 420ms ease, transform 420ms ease;
    }
    .card.ready{
      opacity:1;
      transform: translateY(0);
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; margin-bottom:10px; flex-wrap:wrap;
    }
    .pill{
      font-size:12px; color: var(--muted);
      background: rgba(255,255,255,0.78);
      border:1px solid rgba(15,23,42,0.08);
      padding:6px 10px;
      border-radius:999px;
      box-shadow: 0 8px 22px rgba(2,6,23,0.06);
      user-select:none;
      display:flex; align-items:center; gap:8px; white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: rgb(var(--accent));
      box-shadow: 0 0 0 3px rgba(var(--accent),0.18);
      flex:0 0 auto;
    }

    .photo-frame{
      width:100%;
      height: clamp(360px, 60vh, 600px);
      border-radius:20px;
      border:1px solid rgba(15,23,42,0.10);
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,0.92), rgba(255,255,255,0.68));
      box-shadow: 0 14px 34px rgba(2,6,23,0.14);
      padding:10px;
      display:flex; align-items:center; justify-content:center;
      position:relative;
    }
    .photo-frame::before{
      content:"";
      position:absolute; inset:-40px;
      background: radial-gradient(420px 280px at 50% 30%, rgba(var(--accent),0.24), transparent 72%);
      filter: blur(18px);
      opacity:0.95;
      pointer-events:none;
      transition: opacity 350ms ease;
    }
    .photo{
      width:100%; height:100%;
      object-fit: contain; object-position:center;
      border-radius:14px;
      display:block;
      user-select:none; -webkit-user-drag:none;
      opacity:0; transform: scale(0.995);
      transition: opacity 420ms ease, transform 420ms ease;
      position:relative; z-index:1;
      filter: saturate(1.06) contrast(1.02);
    }
    .photo.is-visible{ opacity:1; transform:scale(1); }

    .msg{ margin:14px 6px 0; font-size:1.10rem; line-height:1.45; min-height:3.2em; }
    .cursor{
      display:inline-block; width:0.55ch;
      background: rgba(var(--accent),0.30);
      margin-left:2px; border-radius:6px;
      transform: translateY(2px);
      animation: blink 1s infinite;
    }
    @keyframes blink{ 0%,49%{opacity:1} 50%,100%{opacity:0.15} }

    .sub{ margin:8px 6px 0; font-size:0.9rem; color:var(--muted); }

    .row{ display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    button{
      flex:1;
      border:1px solid rgba(15,23,42,0.12);
      background: rgba(var(--accent),0.10);
      color: var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:650;
      transition: background 160ms ease, transform 120ms ease;
      min-width: 150px;
    }
    button:hover{ background: rgba(var(--accent),0.16); }
    button:active{ transform: scale(0.99); }
    .ghost{ background: rgba(255,255,255,0.74); }

    .pop{ animation: pop 240ms ease; }
    @keyframes pop{ 0%{transform: translateY(2px); opacity:0.7} 100%{transform: translateY(0); opacity:1} }
  </style>
</head>
<body>
  <div class="confetti" id="confetti"></div>

  <div class="cover" id="cover">
    <div class="cover-card">
      <div class="badge">üéÅ <span>Senin i√ßin k√º√ß√ºk bir ≈üey</span></div>
      <div class="title">Bir Hediyen Var</div>
      <div class="subtitle">A√ßƒ±nca fotoƒüraf + mesaj + m√ºzik ba≈ülar.</div>
      <button class="open-btn" id="btnOpen">Hediyeyi A√ß ‚ú®</button>
    </div>
  </div>

  <div class="card" id="card">
    <div class="topbar">
      <div class="pill" id="pillLeft"><span class="dot" aria-hidden="true"></span><span>Mesaj: ‚Äî</span></div>
      <div class="pill" id="pillRight"><span>Foto: ‚Äî</span></div>
      <div class="pill" id="pillMusic"><span>üéµ</span><span>M√ºzik: Kapalƒ±</span></div>
    </div>

    <div class="photo-frame">
      <img id="photo" class="photo" alt="fotoƒüraf" />
    </div>

    <div class="msg" id="message"></div>
    <div class="sub">Yenileyince yeni mesaj + foto gelir.</div>

    <div class="row">
      <button id="btnNew">Yeni getir</button>
      <button id="btnMusic" class="ghost">üéµ M√ºzik a√ß</button>
      <button id="btnReset" class="ghost">Listeyi sƒ±fƒ±rla</button>
      <button id="btnShare" class="ghost">Payla≈ü</button>
    </div>
  </div>

  <script>
    const MESSAGES = [
      "Bug√ºn de seni seviyorum.",
      "Kalbimden ge√ßenler: iyi ki varsƒ±n.",
      "Biraz susup sarƒ±lasƒ±m var.",
      "G√ºl√º≈ü√ºn d√ºnyayƒ± d√ºzeltemiyor ama beni d√ºzeltiyor.",
      "Yanƒ±ndayƒ±m. Nokta.",
      "ƒ∞√ßimden sana bir c√ºmle d√º≈ü√ºyor: √∂zledim."
    ];

    const PHOTO_DIR   = "assets/yunis/";
    const PHOTO_START = 1;
    const PHOTO_END   = 119;

    const MUSIC_SRC = "assets/music.mp3";

    function storageOK(){
      try{ const k="__t"; localStorage.setItem(k,"1"); localStorage.removeItem(k); return true; }
      catch(e){ return false; }
    }
    const HAS_LS = storageOK();
    const memStore = new Map();

    function lsGet(key, fallback){
      try{
        const raw = HAS_LS ? localStorage.getItem(key) : memStore.get(key);
        return raw ? JSON.parse(raw) : fallback;
      }catch(e){ return fallback; }
    }
    function lsSet(key, value){
      const raw = JSON.stringify(value);
      if(HAS_LS) localStorage.setItem(key, raw);
      else memStore.set(key, raw);
    }
    function lsDel(key){
      if(HAS_LS) localStorage.removeItem(key);
      else memStore.delete(key);
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    function getNextFromPool(poolKey, sourceArray){
      let pool = lsGet(poolKey, null);
      if(!Array.isArray(pool) || pool.length === 0){
        pool = shuffle([...sourceArray]);
      }
      const next = pool.pop();
      lsSet(poolKey, pool);
      return next;
    }
    function resetPool(poolKey){ lsDel(poolKey); }

    function pad4(n){ return String(n).padStart(4,"0"); }
    const PHOTO_LIST = (() => {
      const arr = [];
      for(let i=PHOTO_START;i<=PHOTO_END;i++){
        arr.push(PHOTO_DIR + pad4(i) + ".jpg");
      }
      return arr;
    })();

    let twTimer = null;
    function typewriter(el, text, speed=16){
      if(twTimer) clearInterval(twTimer);
      el.innerHTML = "";
      const span = document.createElement("span");
      const cur = document.createElement("span");
      cur.className = "cursor";
      el.appendChild(span);
      el.appendChild(cur);

      let i = 0;
      twTimer = setInterval(() => {
        i++;
        span.textContent = text.slice(0, i);
        if(i >= text.length){
          clearInterval(twTimer);
          twTimer = null;
        }
      }, speed);
    }

    function setAccent(rgb){
      document.documentElement.style.setProperty("--accent", rgb);
    }
    function accentFromString(str){
      let h = 2166136261;
      for(let i=0;i<str.length;i++){
        h ^= str.charCodeAt(i);
        h = Math.imul(h, 16777619);
      }
      const r = 70 + (h & 0x7F);
      const g = 70 + ((h>>8) & 0x7F);
      const b = 70 + ((h>>16) & 0x7F);
      return `${r},${g},${b}`;
    }
    function tryAccentFromImage(img){
      try{
        const c = document.createElement("canvas");
        const ctx = c.getContext("2d", { willReadFrequently:true });
        const w = 28, h = 28;
        c.width = w; c.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        const data = ctx.getImageData(0,0,w,h).data;

        let r=0,g=0,b=0,count=0;
        for(let i=0;i<data.length;i+=4){
          const a = data[i+3];
          if(a < 120) continue;
          r += data[i]; g += data[i+1]; b += data[i+2];
          count++;
        }
        if(count < 10) return null;

        r = Math.round(r/count);
        g = Math.round(g/count);
        b = Math.round(b/count);

        const max = Math.max(r,g,b), min = Math.min(r,g,b);
        if((max-min) < 10) return null;

        return `${r},${g},${b}`;
      }catch(e){ return null; }
    }

    function nextMessageDifferent(){
      const last = lsGet("last_msg", null);
      let chosen = null;
      for(let t=0;t<8;t++){
        chosen = getNextFromPool("msg_pool", MESSAGES);
        if(chosen !== last) break;
      }
      lsSet("last_msg", chosen);
      return chosen;
    }
    function nextPhotoDifferent(){
      const last = lsGet("last_photo", null);
      let chosen = null;
      for(let t=0;t<12;t++){
        chosen = getNextFromPool("photo_pool", PHOTO_LIST);
        if(chosen !== last) break;
      }
      lsSet("last_photo", chosen);
      return chosen;
    }

    function updatePills(){
      const msgPool = lsGet("msg_pool", []);
      const photoPool = lsGet("photo_pool", []);
      const left = document.getElementById("pillLeft");
      const right = document.getElementById("pillRight");
      left.querySelector("span:last-child").textContent = `Mesaj kaldƒ±: ${msgPool.length || MESSAGES.length}`;
      right.textContent = `Foto kaldƒ±: ${photoPool.length || PHOTO_LIST.length}`;
    }

    const audio = new Audio(MUSIC_SRC);
    audio.loop = true;
    audio.preload = "auto";
    audio.volume = lsGet("music_vol", 0.35);

    function setMusicUI(isOn){
      document.getElementById("pillMusic").lastElementChild.textContent = `M√ºzik: ${isOn ? "A√ßƒ±k" : "Kapalƒ±"}`;
      document.getElementById("btnMusic").textContent = isOn ? "üîá M√ºzik kapat" : "üéµ M√ºzik a√ß";
    }
    async function musicOn(){
      try{
        await audio.play();
        lsSet("music_on", true);
        setMusicUI(true);
      }catch(e){
        lsSet("music_on", false);
        setMusicUI(false);
      }
    }
    function musicOff(){
      audio.pause();
      audio.currentTime = 0;
      lsSet("music_on", false);
      setMusicUI(false);
    }
    async function toggleMusic(){
      if(!audio.paused) musicOff();
      else await musicOn();
    }

    function popConfetti(){
      const layer = document.getElementById("confetti");
      layer.innerHTML = "";
      layer.classList.add("show");

      const n = 22;
      for(let i=0;i<n;i++){
        const p = document.createElement("div");
        p.className = "piece";
        p.style.left = (Math.random()*100) + "vw";
        p.style.animationDelay = (Math.random()*120) + "ms";
        p.style.opacity = (0.6 + Math.random()*0.4).toFixed(2);
        p.style.background = `rgba(var(--accent),${(0.75+Math.random()*0.25).toFixed(2)})`;
        layer.appendChild(p);
      }

      setTimeout(() => {
        layer.classList.remove("show");
        layer.innerHTML = "";
      }, 1600);
    }

    function renderNew(){
      const card = document.getElementById("card");
      card.classList.remove("pop"); void card.offsetWidth; card.classList.add("pop");

      const msg = nextMessageDifferent();
      const photoPath = nextPhotoDifferent();

      typewriter(document.getElementById("message"), msg, 16);

      setAccent(accentFromString(photoPath));

      const img = document.getElementById("photo");
      img.classList.remove("is-visible");
      img.crossOrigin = "anonymous";

      img.onload = () => {
        const fromCanvas = tryAccentFromImage(img);
        if(fromCanvas) setAccent(fromCanvas);
        img.classList.add("is-visible");
        updatePills();
      };

      img.onerror = () => {
        img.onerror = null;
        img.src = PHOTO_DIR + "0001.jpg?v=" + Date.now();
      };

      img.src = photoPath + "?v=" + Date.now();
    }

    const cover = document.getElementById("cover");
    const card = document.getElementById("card");
    const btnOpen = document.getElementById("btnOpen");

    function openGift(){
      cover.classList.add("hidden");
      card.classList.add("ready");
      popConfetti();
      renderNew();
      musicOn();
    }
    btnOpen.addEventListener("click", openGift);

    updatePills();
    setMusicUI(lsGet("music_on", false));

    document.getElementById("btnNew").addEventListener("click", () => {
      renderNew();
      if(lsGet("music_on", false) && audio.paused) musicOn();
    });
    document.getElementById("btnMusic").addEventListener("click", toggleMusic);

    document.getElementById("btnReset").addEventListener("click", () => {
      resetPool("msg_pool");
      resetPool("photo_pool");
      lsDel("last_photo");
      lsDel("last_msg");
      renderNew();
    });

    document.getElementById("btnShare").addEventListener("click", async () => {
      const msg = document.getElementById("message").innerText.trim();
      if(navigator.share){
        try{ await navigator.share({ title:"Bir mesaj", text:msg, url:location.href }); }catch(e){}
      }else{
        try{ await navigator.clipboard.writeText(msg + "\n" + location.href); alert("Kopyalandƒ±."); }
        catch(e){ alert("Bu cihaz payla≈üƒ±m/kopyalama konusunda dramayƒ± se√ßmi≈ü."); }
      }
    });

    window.addEventListener("pageshow", (e) => {
      if(e.persisted){
        if(card.classList.contains("ready")) renderNew();
      }
    });
  </script>
</body>
</html>
